<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Proration Calculator</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%23B0EC9C'/%3E%3Ccircle cx='50' cy='50' r='27' fill='none' stroke='%23231F20' stroke-width='5.5'/%3E%3Cpolyline points='50,34 50,50 62,57' fill='none' stroke='%23231F20' stroke-width='5.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #F4F7F9; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useCallback, useRef } = React;

const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();

const formatCurrency = (amount) =>
  new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(amount);

const formatDate = (date) =>
  date.toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" });

function calculate(annualPrice, startDate, endDate) {
  const monthlyRate = annualPrice / 10;
  let fullMonths = 0;
  let current = new Date(startDate);

  while (true) {
    const nextMonth = new Date(current);
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    const fullMonthEnd = new Date(nextMonth);
    fullMonthEnd.setDate(fullMonthEnd.getDate() - 1);

    if (fullMonthEnd < endDate) {
      fullMonths++;
      current = new Date(fullMonthEnd);
      current.setDate(current.getDate() + 1);
    } else {
      break;
    }
  }

  const partialStart = current;
  const timeDiff = endDate.getTime() - partialStart.getTime();
  const remainingDays = Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1;

  const daysInPartialMonth = getDaysInMonth(partialStart.getFullYear(), partialStart.getMonth());
  const dailyRate = monthlyRate / daysInPartialMonth;
  const partialCost = remainingDays > 0 ? dailyRate * remainingDays : 0;
  const fullMonthsCost = fullMonths * monthlyRate;
  const totalUsed = fullMonthsCost + partialCost;
  const refund = annualPrice - totalUsed;

  return {
    monthlyRate, fullMonths, fullMonthsCost,
    remainingDays: remainingDays > 0 ? remainingDays : 0,
    daysInPartialMonth, dailyRate, partialCost,
    totalUsed, refund, partialStart,
  };
}

const C = {
  brand: "#B0EC9C", brandDark: "#8BD476",
  blue: "#168EEA", blueHover: "#1278C8", blueFocus: "rgba(22,142,234,0.12)",
  heading: "#231F20", headingAlt: "#323B43",
  body: "#59626A", muted: "#8C939A",
  border: "#E0E4E8", bgPage: "#F4F7F9",
  bgCard: "#FFFFFF", bgInput: "#F9FAFB",
  error: "#D64545", errorBg: "#FDF0F0", white: "#FFFFFF",
};

const inputBase = {
  width: "100%", padding: "11px 14px", fontSize: 14,
  fontFamily: "'Inter', -apple-system, sans-serif",
  border: `1.5px solid ${C.border}`, borderRadius: 8,
  outline: "none", background: C.bgInput, color: C.headingAlt,
  boxSizing: "border-box", transition: "border-color 0.2s, box-shadow 0.2s",
};

const focusHandlers = {
  onFocus: (e) => { e.target.style.borderColor = C.blue; e.target.style.boxShadow = `0 0 0 3px ${C.blueFocus}`; },
  onBlur: (e) => { e.target.style.borderColor = C.border; e.target.style.boxShadow = "none"; },
};

function ResultRow({ label, value, highlight, sub, grand }) {
  const isAccent = highlight || grand;
  return (
    <div style={{
      display: "flex", justifyContent: "space-between", alignItems: "baseline",
      padding: sub ? "5px 0 5px 20px" : "10px 0",
      borderBottom: isAccent ? "none" : `1px solid ${C.border}44`,
      ...(isAccent ? {
        background: grand ? C.headingAlt : C.blue,
        margin: grand ? "0 -28px -28px" : "14px -28px -28px",
        padding: grand ? "20px 28px" : "16px 28px",
        borderRadius: "0 0 12px 12px", color: C.white,
      } : {}),
    }}>
      <span style={{ fontSize: sub ? 13 : 14, color: isAccent ? "rgba(255,255,255,0.82)" : C.body, fontFamily: "'Inter', sans-serif" }}>{label}</span>
      <span style={{
        fontSize: isAccent ? (grand ? 24 : 20) : sub ? 13 : 15,
        fontWeight: isAccent ? 700 : sub ? 400 : 600,
        color: isAccent ? C.white : C.headingAlt,
        fontFamily: "'JetBrains Mono', monospace", letterSpacing: "-0.02em",
      }}>{value}</span>
    </div>
  );
}

function ChargeCard({ charge, index, total, onChange, onRemove }) {
  const num = index + 1;
  return (
    <div style={{ background: C.bgCard, borderRadius: 12, padding: 24, border: `1px solid ${C.border}`, marginBottom: 10 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
          <span style={{
            display: "inline-flex", alignItems: "center", justifyContent: "center",
            width: 26, height: 26, borderRadius: 7, background: C.brand,
            color: C.heading, fontSize: 12, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace",
          }}>{num}</span>
          <input type="text" value={charge.label} onChange={(e) => onChange(index, "label", e.target.value)}
            placeholder={`Charge ${num}`}
            style={{ border: "none", outline: "none", fontSize: 16, fontWeight: 700, color: C.heading, fontFamily: "'Poppins', sans-serif", background: "transparent", width: 220 }}
          />
        </div>
        {total > 1 && (
          <button onClick={() => onRemove(index)}
            style={{ background: "none", border: "none", cursor: "pointer", padding: 6, display: "flex", alignItems: "center", justifyContent: "center", borderRadius: 6, transition: "background 0.15s" }}
            onMouseEnter={(e) => e.currentTarget.style.background = C.errorBg}
            onMouseLeave={(e) => e.currentTarget.style.background = "none"}
            title="Remove charge"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={C.error} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        )}
      </div>

      <div style={{ marginBottom: 16 }}>
        <label style={{ fontSize: 13, fontWeight: 600, color: C.headingAlt, display: "block", marginBottom: 6 }}>Annual Price Paid</label>
        <div style={{ position: "relative" }}>
          <span style={{ position: "absolute", left: 14, top: "50%", transform: "translateY(-50%)", fontSize: 14, color: C.muted, fontFamily: "'JetBrains Mono', monospace" }}>$</span>
          <input type="number" value={charge.annualPrice} onChange={(e) => onChange(index, "annualPrice", e.target.value)}
            placeholder="0.00" style={{ ...inputBase, paddingLeft: 30, fontFamily: "'JetBrains Mono', monospace" }} {...focusHandlers} />
        </div>
      </div>

      <div style={{ display: "flex", gap: 12 }}>
        <div style={{ flex: 1 }}>
          <label style={{ fontSize: 13, fontWeight: 600, color: C.headingAlt, display: "block", marginBottom: 6 }}>Start Date</label>
          <input type="date" value={charge.startDate} onChange={(e) => onChange(index, "startDate", e.target.value)} style={inputBase} {...focusHandlers} />
        </div>
        <div style={{ flex: 1 }}>
          <label style={{ fontSize: 13, fontWeight: 600, color: C.headingAlt, display: "block", marginBottom: 6 }}>End Date</label>
          <input type="date" value={charge.endDate}
            onChange={(e) => { onChange(index, "endDate", e.target.value); onChange(index, "useToday", false); }}
            disabled={charge.useToday}
            style={{ ...inputBase, background: charge.useToday ? "#EEF1F3" : C.bgInput, color: charge.useToday ? C.muted : C.headingAlt }}
            {...focusHandlers} />
          <label style={{ display: "flex", alignItems: "center", gap: 6, cursor: "pointer", fontSize: 12, color: C.body, userSelect: "none", marginTop: 8 }}>
            <div onClick={() => onChange(index, "useToday", !charge.useToday)}
              style={{
                width: 14, height: 14, borderRadius: 3,
                border: charge.useToday ? "none" : `1.5px solid ${C.border}`,
                background: charge.useToday ? C.blue : C.white,
                display: "flex", alignItems: "center", justifyContent: "center",
                transition: "all 0.2s", flexShrink: 0,
              }}>
              {charge.useToday && (
                <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="#fff" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
                  <polyline points="20 6 9 17 4 12" />
                </svg>
              )}
            </div>
            Use today's date
          </label>
        </div>
      </div>
    </div>
  );
}

function ChargeResult({ result, index }) {
  const r = result.calc;
  const label = result.label || `Charge ${index + 1}`;
  return (
    <div style={{
      background: C.bgCard, borderRadius: 12, padding: 28, border: `1px solid ${C.border}`, marginBottom: 10,
      animation: "fadeIn 0.3s ease", animationDelay: `${index * 0.06}s`, animationFillMode: "both",
    }}>
      <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 4 }}>
        <span style={{
          display: "inline-flex", alignItems: "center", justifyContent: "center",
          width: 22, height: 22, borderRadius: 6, background: C.brand,
          color: C.heading, fontSize: 11, fontWeight: 700, fontFamily: "'JetBrains Mono', monospace",
        }}>{index + 1}</span>
        <h3 style={{ fontSize: 16, fontWeight: 700, color: C.heading, margin: 0, fontFamily: "'Poppins', sans-serif" }}>{label}</h3>
      </div>
      <p style={{ fontSize: 12, color: C.muted, margin: "0 0 14px", fontFamily: "'Inter', sans-serif" }}>
        {formatDate(result.start)} to {formatDate(result.end)}
      </p>

      <ResultRow label="Annual price" value={formatCurrency(result.price)} />
      <ResultRow label={`Monthly rate (${formatCurrency(result.price)} / 10)`} value={formatCurrency(r.monthlyRate)} />
      <ResultRow label="Full months used" value={`${r.fullMonths} month${r.fullMonths !== 1 ? "s" : ""}`} />
      <ResultRow label={`Full months cost (${r.fullMonths} x ${formatCurrency(r.monthlyRate)})`} value={formatCurrency(r.fullMonthsCost)} />

      {r.remainingDays > 0 && (
        <>
          <div style={{ height: 4 }} />
          <ResultRow label={`Days in partial month (${r.partialStart.toLocaleDateString("en-US", { month: "long" })})`} value={`${r.daysInPartialMonth} days`} sub />
          <ResultRow label={`Daily rate (${formatCurrency(r.monthlyRate)} / ${r.daysInPartialMonth})`} value={formatCurrency(r.dailyRate)} sub />
          <ResultRow label="Remaining days used" value={`${r.remainingDays} day${r.remainingDays !== 1 ? "s" : ""}`} sub />
          <ResultRow label={`Partial month cost (${r.remainingDays} x ${formatCurrency(r.dailyRate)})`} value={formatCurrency(r.partialCost)} />
        </>
      )}

      <div style={{ height: 2 }} />
      <ResultRow label="Total used" value={formatCurrency(r.totalUsed)} />
      <ResultRow label="Refund for this charge" value={formatCurrency(r.refund)} highlight />
    </div>
  );
}

const makeCharge = () => ({ label: "", annualPrice: "", startDate: "", endDate: "", useToday: true });

function ProrationCalculator() {
  const [charges, setCharges] = useState([makeCharge()]);
  const [results, setResults] = useState(null);
  const [error, setError] = useState("");
  const bottomRef = useRef(null);

  const updateCharge = useCallback((index, field, value) => {
    setCharges((prev) => prev.map((c, i) => (i === index ? { ...c, [field]: value } : c)));
  }, []);

  const removeCharge = useCallback((index) => {
    setCharges((prev) => prev.filter((_, i) => i !== index));
  }, []);

  const addCharge = useCallback(() => {
    setCharges((prev) => [...prev, makeCharge()]);
  }, []);

  const handleCalculate = useCallback(() => {
    setError("");
    setResults(null);

    const computed = [];
    for (let i = 0; i < charges.length; i++) {
      const c = charges[i];
      const price = parseFloat(c.annualPrice);
      if (!price || price <= 0) { setError(`Charge ${i + 1}: Please enter a valid annual price.`); return; }
      if (!c.startDate) { setError(`Charge ${i + 1}: Please enter a start date.`); return; }
      const start = new Date(c.startDate + "T00:00:00");
      let end;
      if (c.useToday) { end = new Date(); end.setHours(0, 0, 0, 0); }
      else {
        if (!c.endDate) { setError(`Charge ${i + 1}: Please enter an end date or use today.`); return; }
        end = new Date(c.endDate + "T00:00:00");
      }
      if (end <= start) { setError(`Charge ${i + 1}: End date must be after the start date.`); return; }
      computed.push({ calc: calculate(price, start, end), start, end, price, label: c.label });
    }
    setResults(computed);
    setTimeout(() => bottomRef.current?.scrollIntoView({ behavior: "smooth" }), 50);
  }, [charges]);

  const totalRefund = results ? results.reduce((sum, r) => sum + r.calc.refund, 0) : 0;
  const totalUsed = results ? results.reduce((sum, r) => sum + r.calc.totalUsed, 0) : 0;
  const totalAnnual = results ? results.reduce((sum, r) => sum + r.price, 0) : 0;

  return (
    <div style={{
      minHeight: "100vh", background: C.bgPage, fontFamily: "'Inter', -apple-system, sans-serif",
      display: "flex", alignItems: "flex-start", justifyContent: "center", padding: "48px 16px",
    }}>
      <div style={{ width: "100%", maxWidth: 480 }}>
        <div style={{ marginBottom: 32, textAlign: "center" }}>
          <div style={{
            display: "inline-flex", alignItems: "center", justifyContent: "center",
            width: 44, height: 44, borderRadius: 10, background: C.brand, marginBottom: 16,
          }}>
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={C.heading} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
              <circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" />
            </svg>
          </div>
          <h1 style={{ fontSize: 26, fontFamily: "'Poppins', sans-serif", fontWeight: 700, color: C.heading, margin: "0 0 6px", letterSpacing: "-0.01em" }}>
            Proration Calculator
          </h1>
          <p style={{ fontSize: 15, color: C.body, margin: 0, lineHeight: 1.5, fontFamily: "'Inter', sans-serif" }}>
            Calculate refunds for annual software subscriptions
          </p>
        </div>

        {charges.map((charge, i) => (
          <ChargeCard key={i} charge={charge} index={i} total={charges.length} onChange={updateCharge} onRemove={removeCharge} />
        ))}

        <button onClick={addCharge}
          style={{
            width: "100%", padding: "11px", fontSize: 14, fontWeight: 500,
            fontFamily: "'Inter', sans-serif", color: C.blue, background: C.bgCard,
            border: `1.5px dashed ${C.border}`, borderRadius: 10, cursor: "pointer",
            transition: "all 0.2s", marginBottom: 14,
            display: "flex", alignItems: "center", justifyContent: "center", gap: 8,
          }}
          onMouseEnter={(e) => { e.currentTarget.style.borderColor = C.blue; e.currentTarget.style.background = C.blueFocus; }}
          onMouseLeave={(e) => { e.currentTarget.style.borderColor = C.border; e.currentTarget.style.background = C.bgCard; }}
        >
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
            <line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          Add another charge
        </button>

        {error && (
          <div style={{ background: C.errorBg, border: "1px solid #F5C6C6", borderRadius: 8, padding: "10px 14px", fontSize: 13, color: C.error, marginBottom: 14, fontFamily: "'Inter', sans-serif" }}>
            {error}
          </div>
        )}

        <button onClick={handleCalculate}
          style={{
            width: "100%", padding: "13px", fontSize: 15, fontWeight: 600,
            fontFamily: "'Poppins', sans-serif", color: C.white, background: C.blue,
            border: "none", borderRadius: 10, cursor: "pointer", transition: "all 0.2s", marginBottom: 28,
          }}
          onMouseEnter={(e) => { e.target.style.background = C.blueHover; e.target.style.transform = "translateY(-1px)"; e.target.style.boxShadow = "0 4px 12px rgba(22,142,234,0.3)"; }}
          onMouseLeave={(e) => { e.target.style.background = C.blue; e.target.style.transform = "translateY(0)"; e.target.style.boxShadow = "none"; }}
        >
          {`Calculate Refund${charges.length > 1 ? "s" : ""}`}
        </button>

        {results && (
          <>
            {results.map((r, i) => (
              <ChargeResult key={i} result={r} index={i} />
            ))}

            {results.length > 1 && (
              <div style={{
                background: C.bgCard, borderRadius: 12, padding: 28, border: `1px solid ${C.border}`, marginTop: 2,
                animation: "fadeIn 0.3s ease", animationDelay: `${results.length * 0.06}s`, animationFillMode: "both",
              }}>
                <h3 style={{ fontSize: 16, fontWeight: 700, color: C.heading, margin: "0 0 14px", fontFamily: "'Poppins', sans-serif" }}>Combined Total</h3>
                <ResultRow label="Total annual charges" value={formatCurrency(totalAnnual)} />
                <ResultRow label="Total amount used" value={formatCurrency(totalUsed)} />
                <ResultRow label="Total refund owed" value={formatCurrency(totalRefund)} grand />
              </div>
            )}
          </>
        )}

        <p ref={bottomRef} style={{
          textAlign: "center", fontSize: 10, color: "#CDD1D5", marginTop: 28,
          lineHeight: 1.6, fontFamily: "'Inter', sans-serif", maxWidth: 380, marginLeft: "auto", marginRight: "auto",
        }}>
          Refunds are calculated by removing the annual discount and prorating based on the full monthly rate (annual price / 10) for the time used.
        </p>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<ProrationCalculator />);
</script>
</body>
</html>
